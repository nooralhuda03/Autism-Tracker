{% extends 'base_mother.html' %}
{% block title %}Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„{% endblock %}

{% block head %}
    {{ super() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .report-link {
            transition: background-color 0.2s;
            border-radius: 5px;
            margin-bottom: 5px;
        }
        .report-link.active-item {
            background-color: #e6e9ff !important;
            border-right: 4px solid #6a1b9a;
            font-weight: bold;
        }
        #chart-container {
            position: relative;
            height: 450px;
            width: 100%;
        }
    </style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h3 class="text-center mb-5" style="color: #6a1b9a;">Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ ğŸ“Š</h3>

    <div class="row">
        <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠØ³Ø± (Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±) -->
        <div class="col-md-3">
            <div class="card shadow-sm mb-4 p-3" style="border-radius: 10px;">
                <h5 style="color: #d16ba5;"><i class="fas fa-filter me-2"></i> Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h5>
                <div class="list-group list-group-flush">
                    <a href="#" class="list-group-item list-group-item-action fw-bold active"
                       data-type="daily"
                       onclick="loadReportList('daily', this); return false;">
                       <i class="fas fa-sun me-2"></i> ØªÙ‚Ø§Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠØ©
                    </a>
                    <a href="#" class="list-group-item list-group-item-action fw-bold"
                       data-type="weekly"
                       onclick="loadReportList('weekly', this); return false;">
                       <i class="fas fa-calendar-week me-2"></i> ØªÙ‚Ø§Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©
                    </a>
                    <a href="#" class="list-group-item list-group-item-action fw-bold"
                       data-type="monthly"
                       onclick="loadReportList('monthly', this); return false;">
                       <i class="fas fa-calendar-alt me-2"></i> ØªÙ‚Ø§Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠØ©
                    </a>
                </div>
            </div>

            <h5 class="mt-4" style="color: #d16ba5;"><i class="fas fa-list me-2"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØªØ§Ø­Ø©</h5>
            <div class="list-group" id="report-items-list">
                <div class="p-3 text-muted border rounded">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ ØªÙ‚Ø±ÙŠØ±...</div>
            </div>
        </div>

        <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠÙ…Ù† (Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ) -->
        <div class="col-md-9">
            <div class="card shadow p-4 rounded" style="border-radius: 10px;">
                <h4 id="chart-title" style="color: #a64ca6;">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØªÙ‚Ø±ÙŠØ±</h4>
                <hr>

                <div id="chart-container">
                    <canvas id="myReportChart"></canvas>
                </div>

                <div id="no-data-message" class="alert alert-warning text-center mt-3" style="display: none;">
                    Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙˆÙØ±Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø£Ùˆ Ø§Ù„ÙØªØ±Ø©.
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentChart = null;

    // âœ… Ø£Ø®Ø° child_id Ù…Ù† Flask Ù…Ø¨Ø§Ø´Ø±Ø©
    let currentChildId = {{ child.child_id | tojson if child else 'null' }};
    let currentReportType = 'daily';

    document.addEventListener('DOMContentLoaded', function() {
        console.log("âœ… Loaded doctor report page for child_id:", currentChildId);

        if (currentChildId) {
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø©
            loadReportList(currentReportType, document.querySelector('[data-type="daily"]'));
        } else {
            document.getElementById('chart-title').textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø·ÙØ§Ù„ Ù…Ø³Ø¬Ù„ÙˆÙ†.";
        }
    });

    // ----------------------------------------
    // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
    // ----------------------------------------
    function loadReportList(reportType, element) {
        currentReportType = reportType;

        document.querySelectorAll('.list-group-item-action').forEach(el => el.classList.remove('active'));
        element.classList.add('active');

        const listContainer = document.getElementById('report-items-list');
        listContainer.innerHTML = '<div class="p-3 text-center text-info"><i class="fas fa-spinner fa-spin me-2"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

        if (!currentChildId) {
            listContainer.innerHTML = '<div class="p-3 text-muted border rounded">ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø·ÙÙ„ Ø£ÙˆÙ„Ø§Ù‹.</div>';
            return;
        }

        // âœ… Ø¬Ù„Ø¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø·ÙÙ„
        fetch(`/api/report/list/${reportType}?child_id=${currentChildId}`)
            .then(response => response.json())
            .then(data => {
                listContainer.innerHTML = '';
                document.getElementById('chart-title').textContent = data.title;

                if (!data.items || data.items.length === 0) {
                    listContainer.innerHTML = '<div class="p-3 text-muted border rounded">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.</div>';
                    if (currentChart) { currentChart.destroy(); currentChart = null; }
                    return;
                }

                data.items.forEach(item => {
                    const link = document.createElement('a');
                    link.href = '#';
                    link.className = 'list-group-item list-group-item-action report-link';
                    link.textContent = item.title;
                    link.onclick = (e) => {
                        e.preventDefault();
                        loadReportChart(reportType, item.id, item.child_id, link);
                    };
                    listContainer.appendChild(link);
                });

                // Ø¹Ø±Ø¶ Ø£ÙˆÙ„ ØªÙ‚Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
                const firstLink = listContainer.querySelector('a');
                if (firstLink) {
                    loadReportChart(reportType, data.items[0].id, data.items[0].child_id, firstLink);
                }
            })
            .catch(error => {
                console.error('âŒ Error loading report list:', error);
                listContainer.innerHTML = '<div class="p-3 text-danger border rounded">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.</div>';
            });
    }

    // ----------------------------------------
    // Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆØ¹Ø±Ø¶Ù‡Ø§ Ø¨Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
    // ----------------------------------------
    function loadReportChart(reportType, reportId, childId, linkElement) {
        document.querySelectorAll('.report-link').forEach(el => el.classList.remove('active-item'));
        linkElement.classList.add('active-item');

        document.getElementById('no-data-message').style.display = 'none';
        document.getElementById('chart-title').textContent = linkElement.textContent;
        document.getElementById('chart-container').style.opacity = '0.5';

        fetch(`/api/report/data/${reportType}/${reportId}/${childId}`)
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => Promise.reject(data));
                }
                return response.json();
            })
            .then(chartData => {
                document.getElementById('chart-container').style.opacity = '1';
                if (currentChart) currentChart.destroy();

                const ctx = document.getElementById('myReportChart').getContext('2d');
                const chartType = (reportType === 'daily') ? 'bar' : 'line';
                const labelText = (reportType === 'daily') ? 'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ (5 = Ù…Ù…ØªØ§Ø²)' : 'Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…';

                currentChart = new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            label: labelText,
                            data: chartData.data,
                            backgroundColor: (chartType === 'bar')
                                ? 'rgba(166, 76, 166, 0.7)'
                                : 'rgba(106, 27, 154, 0.5)',
                            borderColor: 'rgba(106, 27, 154, 1)',
                            borderWidth: 2,
                            tension: (chartType === 'line') ? 0.3 : 0,
                            fill: (chartType === 'line')
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 5.2,
                                title: { display: true, text: 'Ø§Ù„ØªÙ‚ÙŠÙŠÙ…' }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'ØªØ­Ù„ÙŠÙ„ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø·ÙÙ„: ' + chartData.child_name,
                                font: { size: 16 }
                            }
                        },
                        rtl: true
                    }
                });
            })
            .catch(error => {
                console.error('âŒ Error loading chart:', error);
                document.getElementById('chart-container').style.opacity = '1';
                document.getElementById('no-data-message').textContent =
                    error.error || "ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ.";
                document.getElementById('no-data-message').style.display = 'block';
                if (currentChart) { currentChart.destroy(); currentChart = null; }
            });
    }
</script>
{% endblock %}
